"use strict";!function($){$.fn.jsonTagEditor=function(options,val,blur){function escape(tag){return tag.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function validateTagArray(json){try{return JSON.parse(json).map(function(tagArrayElement){return validate(JSON.stringify(tagArrayElement))}).filter(function(element){return element})}catch(e){return json.split(o.dregex).map(function(tagArrayElement){return tagArrayElement.trim().length>0&&{value:tagArrayElement.trim()}}).filter(function(element){return element})}}function validateParsedTag(tagObject){return tagObject.hasOwnProperty("value")&&"string"==typeof tagObject.value&&tagObject.value.trim().length>0}function validate(tag){try{var parsedTag=JSON.parse(tag);if(validateParsedTag(parsedTag))return parsedTag}catch(e){}return String(tag).trim().length>0&&{value:String(tag).trim()}}function ellipsify(str,maxLength){return maxLength>-1&&str.length>maxLength?str.substring(0,maxLength-1)+"â€¦":str}function deepEquals(arr1,arr2){return 0===$(arr1).not(arr2).length&&0===$(arr2).not(arr1).length}var blurResult,o=$.extend({},$.fn.jsonTagEditor.defaults,options),selector=this;if(o.delimiter="\t\n",o.dregex=new RegExp("["+o.delimiter+"]","g"),"string"==typeof options){var response=[];return selector.each(function(){var el=$(this),o=el.data("options"),ed=el.next(".json-tag-editor");switch(options){case"getTags":response.push({field:el[0],editor:ed,tags:ed.data("tags")});break;case"addTag":if(o.maxTags&&ed.data("tags").length>=o.maxTags)return!1;$("<li></li>").append('<div class="json-tag-editor-spacer">&nbsp;'+o.delimiter[0]+"</div>").append('<div class="json-tag-editor-tag"></div>').append('<div class="json-tag-editor-delete"><i></i></div>').appendTo(ed).find(".json-tag-editor-tag").append('<input type="text" maxlength="'+o.maxLength+'">').addClass("active").find("input").val(val).blur(),blur?$(".placeholder",ed).remove():ed.click();break;case"removeTag":$(".json-tag-editor-tag",ed).filter(function(){return $(this).get(0).dataset.value===val}).closest("li").find(".json-tag-editor-delete").click(),blur||ed.click();break;case"destroy":el.removeClass("json-tag-editor-hidden-src").removeData("options").off("focus.json-tag-editor").next(".json-tag-editor").remove();break;default:return this}}),"getTags"===options?response:this}return window.getSelection&&$(document).off("keydown.json-tag-editor").on("keydown.json-tag-editor",function(e){if(8===e.which||46===e.which){try{var sel=getSelection(),el="BODY"===document.activeElement.tagName?$(sel.getRangeAt(0).startContainer.parentNode).closest(".json-tag-editor"):0}catch(e){el=0}if(sel.rangeCount>0&&el&&el.length)return $(".json-tag-editor-tag",el).each(function(){sel.containsNode($(this).get(0))&&$(this).closest("li").find(".json-tag-editor-delete").click()}),!1}}),selector.each(function(){function setPlaceholder(){!o.placeholder||tagList.length||$(".deleted, .placeholder, input",ed).length||ed.append('<li class="placeholder"><div>'+o.placeholder+"</div></li>")}function updateGlobals(init){var oldTags=tagList;tagList=$(".json-tag-editor-tag:not(.deleted)",ed).map(function(i,e){var tag={};if($(this).hasClass("active")?(Object.assign(tag,$(this).find("input").get(0).dataset),tag.value=$(this).find("input").val()):Object.assign(tag,$(e).get(0).dataset,{value:$(e).get(0).dataset.value}),tag.value)return tag}).get(),ed.data("tags",tagList),el.val(tagList.reduce(function(previous,current){return previous+o.delimiter[0]+current.value},"")),init||deepEquals(oldTags,tagList)||o.onChange(el,ed,tagList),setPlaceholder()}function splitCleanup(input,text){for(var cbVal,li=input.closest("li"),subTags=text?text.replace(/ +/," ").split(o.dregex):input.val().replace(/ +/," ").split(o.dregex),oldTag=input.data("old_tag"),oldTags=tagList.slice(0),exceeded=!1,i=0;i<subTags.length;i++){var tag=$.trim(subTags[i]).slice(0,o.maxLength);if(o.forceLowercase&&(tag=tag.toLowerCase()),cbVal=o.beforeTagSave(el,ed,oldTags,oldTag,tag),tag=cbVal||tag,cbVal!==!1&&tag){var tagObject=validate(tag);if(tagObject){for(var $tagEditorTag=$('<div class="json-tag-editor-tag"'+(tag.length>o.maxTagLength?' title="'+escape(tagObject.value)+'"':"")+">"+escape(ellipsify(tagObject.value,o.maxTagLength))+"</div>"),tagProperties=Object.keys(tagObject),j=0;j<tagProperties.length;j++)$tagEditorTag.get(0).dataset[tagProperties[j]]=tagObject[tagProperties[j]];if(oldTags.push(tagObject),li.before($("<li></li>").append('<div class="json-tag-editor-spacer">&nbsp;'+o.delimiter[0]+"</div>").append($tagEditorTag).append('<div class="json-tag-editor-delete"><i></i></div>')),o.maxTags&&oldTags.length>=o.maxTags){exceeded=!0;break}}}}input.closest("li").remove(),updateGlobals()}var el=$(this),tagList=[],ed=$("<ul "+(o.clickDelete?'oncontextmenu="return false;" ':"")+'class="json-tag-editor'+(options.noSelect?' noselect"':'"')+"></ul>").insertAfter(el);el.addClass("json-tag-editor-hidden-src").data("options",o).on("focus.json-tag-editor",function(){ed.click()}),ed.append('<li style="width:1px">&nbsp;</li>');var newTag='<li><div class="json-tag-editor-spacer">&nbsp;'+o.delimiter[0]+'</div><div class="json-tag-editor-tag"></div><div class="json-tag-editor-delete"><i></i></div></li>';ed.click(function(e,closestTag){var d,loc,dist=99999;if(!window.getSelection||""===getSelection().toString())return o.maxTags&&ed.data("tags").length>=o.maxTags?(ed.find("input").blur(),!1):(blurResult=!0,$("input:focus",ed).blur(),!!blurResult&&(blurResult=!0,$(".placeholder",ed).remove(),closestTag&&closestTag.length?loc="before":$(".json-tag-editor-tag",ed).each(function(){var tag=$(this),to=tag.offset(),tagX=to.left,tagY=to.top;e.pageY>=tagY&&e.pageY<=tagY+tag.height()&&(e.pageX<tagX?(loc="before",d=tagX-e.pageX):(loc="after",d=e.pageX-tagX-tag.width()),d<dist&&(dist=d),closestTag=tag)}),"before"===loc?$(newTag).insertBefore(closestTag.closest("li")).find(".json-tag-editor-tag").click():"after"===loc?$(newTag).insertAfter(closestTag.closest("li")).find(".json-tag-editor-tag").click():$(newTag).appendTo(ed).find(".json-tag-editor-tag").click(),!1))}),ed.on("click",".json-tag-editor-delete",function(e){if($(this).prev().hasClass("active"))return $(this).closest("li").find("input").caret(-1),!1;var li=$(this).closest("li"),tag=li.find(".json-tag-editor-tag");return o.beforeTagDelete(el,ed,tagList,tag.text())!==!1&&(tag.addClass("deleted").animate({width:0},o.animateDelete,function(){li.remove(),setPlaceholder()}),updateGlobals(),!1)}),o.clickDelete&&ed.on("mousedown",".json-tag-editor-tag",function(e){if(e.ctrlKey||e.which>1){var li=$(this).closest("li"),tag=li.find(".json-tag-editor-tag");return o.beforeTagDelete(el,ed,tagList,tag.text())!==!1&&(tag.addClass("deleted").animate({width:0},o.animateDelete,function(){li.remove(),setPlaceholder()}),updateGlobals(),!1)}}),ed.on("click",".json-tag-editor-tag",function(e){if(o.clickDelete&&(e.ctrlKey||e.which>1))return!1;if(!$(this).hasClass("active")){var value=$(this).get(0).dataset.value?$(this).get(0).dataset.value:$(this).text(),tagDisplay=$(this).text(),leftPercent=Math.abs(($(this).offset().left-e.pageX)/$(this).width()),caretPos=parseInt(tagDisplay.length*leftPercent),input=$(this).html('<input type="text" maxlength="'+o.maxLength+'" value="'+escape(value)+'">').addClass("active").find("input");if(input.data("old_tag",value).focus().caret(caretPos),o.autocomplete){var aco=$.extend({},o.autocomplete),acSelect="select"in aco?o.autocomplete.select:"";aco.select=function(e,ui){acSelect&&acSelect(e,ui),setTimeout(function(){ed.trigger("click",[$(".active",ed).find("input").closest("li").next("li").find(".json-tag-editor-tag")])},20)},input.autocomplete(aco),aco._renderItem&&(input.autocomplete("instance")._renderItem=aco._renderItem)}}return!1}),ed.on("blur","input",function(e){e.stopPropagation();var input=$(this),oldTag=input.data("old_tag"),tag=$.trim(input.val().replace(/ +/," ").replace(o.dregex,o.delimiter[0]));if(tag){if(tag.indexOf(o.delimiter[0])>=0)return void splitCleanup(input);if(tag!=oldTag){o.forceLowercase&&(tag=tag.toLowerCase());var cbVal=o.beforeTagSave(el,ed,tagList,oldTag,tag);if(tag=cbVal||tag,cbVal===!1){if(oldTag)return input.val(oldTag).focus(),blurResult=!1,void updateGlobals();try{input.closest("li").remove()}catch(e){}oldTag&&updateGlobals()}}}else{if(oldTag&&o.beforeTagDelete(el,ed,tagList,oldTag)===!1)return input.val(oldTag).focus(),blurResult=!1,void updateGlobals();try{input.closest("li").remove()}catch(e){}oldTag&&updateGlobals()}var $tagEditorTag=input.parent(),tagObject=validate(tag);if(tagObject){for(var tagProperties=Object.keys(tagObject),i=0;i<tagProperties.length;i++)$tagEditorTag.get(0).dataset[tagProperties[i]]=tagObject[tagProperties[i]];tagObject.value.length>o.maxTagLength?$tagEditorTag.attr("title",escape(tagObject.value)):$tagEditorTag.removeAttr("title"),$tagEditorTag.html(escape(ellipsify(tagObject.value,o.maxTagLength))).removeClass("active")}tag!=oldTag&&updateGlobals(),setPlaceholder()}),ed.on("paste","input",function(e){var pastedContent,inputContent;$(this).removeAttr("maxlength"),pastedContent=(e.originalEvent||e).clipboardData.getData("text/plain"),inputContent=$(this),setTimeout(function(){splitCleanup(inputContent,pastedContent)},30)}),ed.on("keypress","input",function(e){if(o.delimiter.indexOf(String.fromCharCode(e.which))>=0){var inp=$(this);setTimeout(function(){splitCleanup(inp)},20)}}),ed.on("keydown","input",function(e){var previousTag,nextTag,$this=$(this);if((37===e.which||!o.autocomplete&&38===e.which)&&!$this.caret()||8===e.which&&!$this.val())return previousTag=$this.closest("li").prev("li").find(".json-tag-editor-tag"),previousTag.length?previousTag.click().find("input").caret(-1):!$this.val()||o.maxTags&&ed.data("tags").length>=o.maxTags||$(newTag).insertBefore($this.closest("li")).find(".json-tag-editor-tag").click(),!1;if((39===e.which||!o.autocomplete&&40===e.which)&&$this.caret()===$this.val().length)return nextTag=$this.closest("li").next("li").find(".json-tag-editor-tag"),nextTag.length?nextTag.click().find("input").caret(0):$this.val()&&ed.click(),!1;if(9===e.which){if(e.shiftKey){if(previousTag=$this.closest("li").prev("li").find(".json-tag-editor-tag"),previousTag.length)previousTag.click().find("input").caret(0);else{if(!$this.val()||o.maxTags&&ed.data("tags").length>=o.maxTags)return el.attr("disabled","disabled"),void setTimeout(function(){el.removeAttr("disabled")},30);$(newTag).insertBefore($this.closest("li")).find(".json-tag-editor-tag").click()}return!1}if(nextTag=$this.closest("li").next("li").find(".json-tag-editor-tag"),nextTag.length)nextTag.click().find("input").caret(0);else{if(!$this.val())return;ed.click()}return!1}if(!(46!==e.which||$.trim($this.val())&&$this.caret()!==$this.val().length))return nextTag=$this.closest("li").next("li").find(".json-tag-editor-tag"),nextTag.length?nextTag.click().find("input").caret(0):$this.val()&&ed.click(),!1;if(13===e.which)return ed.trigger("click",[$this.closest("li").next("li").find(".json-tag-editor-tag")]),o.maxTags&&ed.data("tags").length>=o.maxTags&&ed.find("input").blur(),!1;if(36!==e.which||$this.caret()){if(35===e.which&&$this.caret()===$this.val().length)ed.find(".json-tag-editor-tag").last().click();else if(27===e.which)return $this.val($this.data("old_tag")?$this.data("old_tag"):"").blur(),!1}else ed.find(".json-tag-editor-tag").first().click()});for(var tags=o.initialTags.length?o.initialTags.map(function(element){return validateParsedTag(element)?element:validate(element)}):validateTagArray(el.val()),i=0;i<tags.length&&!(o.maxTags&&i>=o.maxTags);i++){var tagObject=tags[i];if(tagObject){o.forceLowercase&&(tagObject.value=tagObject.value.toLowerCase()),tagList.push(tagObject);for(var $tagEditorTag=$('<div class="json-tag-editor-tag"'+(tagObject.length>o.maxTagLength?' title="'+escape(tagObject.value)+'"':"")+">"+escape(ellipsify(tagObject.value,o.maxTagLength))+"</div>"),tagProperties=Object.keys(tagObject),j=0;j<tagProperties.length;j++)$tagEditorTag.get(0).dataset[tagProperties[j]]=tagObject[tagProperties[j]];ed.append($("<li></li>").append('<div class="json-tag-editor-spacer">&nbsp;'+o.delimiter[0]+"</div>").append($tagEditorTag).append('<div class="json-tag-editor-delete"><i></i></div>'))}}updateGlobals(!0),o.sortable&&$.fn.sortable&&ed.sortable({distance:5,cancel:".json-tag-editor-spacer, input",helper:"clone",update:function(){updateGlobals()}})})},$.fn.jsonTagEditor.defaults={initialTags:[],maxTags:0,maxLength:50,maxTagLength:-1,placeholder:"",forceLowercase:!1,clickDelete:!1,animateDelete:175,noSelect:!1,sortable:!0,autocomplete:null,onChange:function(){},beforeTagSave:function(){},beforeTagDelete:function(){}}}(jQuery);

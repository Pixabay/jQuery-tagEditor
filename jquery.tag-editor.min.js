// jQuery tagEditor v1.0.14
// https://github.com/Pixabay/jQuery-tagEditor
(function(a){a.fn.tagEditorInput=function(){var c=" ",f=a(this),g=parseInt(f.css("fontSize")),b=a("<span/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:f.css("fontSize"),fontFamily:f.css("fontFamily"),fontWeight:f.css("fontWeight"),letterSpacing:f.css("letterSpacing"),whiteSpace:"nowrap"}),d=function(){if(c!==(c=f.val())){b.html(c.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));var e=b.width()+g;20>e&&(e=20),e!=f.width()&&f.width(e)}};return b.insertAfter(f),f.bind("keyup keydown focus",d)};a.fn.tagEditor=function(d,j,h){var g,f=a.extend({},a.fn.tagEditor.defaults,d),b=this;f.dregex=new RegExp("["+f.delimiter.replace("-","-")+"]","g");if(typeof d=="string"){var c=[];b.each(function(){var l=a(this),m=l.data("options"),k=l.next(".tag-editor");if(d=="getTags"){c.push({field:l[0],editor:k,tags:k.data("tags")})}else{if(d=="addTag"){a('<li><div class="tag-editor-spacer">&nbsp;'+m.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>').appendTo(k).find(".tag-editor-tag").html('<input type="text" maxlength="'+m.maxLength+'">').addClass("active").find("input").val(j).blur();if(!h){k.click()}else{a(".placeholder",k).remove()}}else{if(d=="removeTag"){a(".tag-editor-tag",k).filter(function(){return a(this).html()==j}).closest("li").find(".tag-editor-delete").click();if(!h){k.click()}}else{if(d=="destroy"){l.removeClass("tag-editor-hidden-src").removeData("options").off("focus.tag-editor").next(".tag-editor").remove()}}}}});return d=="getTags"?c:this}function e(p){if(p.which==8||p.which==46||p.ctrlKey&&p.which==88){try{var n=getSelection(),m=a(n.getRangeAt(0).commonAncestorContainer)}catch(p){m=0}if(m&&m.hasClass("tag-editor")){var l=[],o=n.toString().split(m.prev().data("options").dregex);for(i=0;i<o.length;i++){var k=a.trim(o[i]);if(k){l.push(k)}}a(".tag-editor-tag",m).each(function(){if(~a.inArray(a(this).html(),l)){a(this).closest("li").find(".tag-editor-delete").click()}})}}}if(window.getSelection){a(document).off("keydown.tag-editor").on("keydown.tag-editor",e)}return b.each(function(){var l=a(this),s=[];var p=a("<ul "+(f.clickDelete?'oncontextmenu="return false;" ':"")+'class="tag-editor"></ul>').insertAfter(l);l.addClass("tag-editor-hidden-src").data("options",f).on("focus.tag-editor",function(){p.click()});p.append('<li style="width:1px">&nbsp;</li>');var n='<li><div class="tag-editor-spacer">&nbsp;'+f.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>';function m(){if(f.placeholder&&!s.length&&!a(".deleted, .placeholder, input",p).length){p.append('<li class="placeholder"><div>'+f.placeholder+"</div></li>")}}function r(w){var v=s.toString();s=a(".tag-editor-tag:not(.deleted)",p).map(function(x,y){var z=a.trim(a(this).hasClass("active")?a(this).find("input").val():a(y).text());if(z){return z}}).get();p.data("tags",s);l.val(s.join(f.delimiter[0]));if(!w){if(v!=s.toString()){f.onChange(l,p,s)}}m()}p.click(function(w,v){var z,y=99999,x;if(window.getSelection&&getSelection()!=""){return}g=true;a("input:focus",p).blur();if(!g){return false}g=true;a(".placeholder",p).remove();if(v&&v.length){x="before"}else{a(".tag-editor-tag",p).each(function(){var A=a(this),D=A.offset(),C=D.left,B=D.top;if(w.pageY>=B&&w.pageY<=B+A.height()){if(w.pageX<C){x="before",z=C-w.pageX}else{x="after",z=w.pageX-C-A.width()}if(z<y){y=z,v=A}}})}if(x=="before"){a(n).insertBefore(v.closest("li")).find(".tag-editor-tag").click()}else{if(x=="after"){a(n).insertAfter(v.closest("li")).find(".tag-editor-tag").click()}else{a(n).appendTo(p).find(".tag-editor-tag").click()}}return false});p.on("click",".tag-editor-delete",function(x){if(a(this).prev().hasClass("active")){a(this).closest("li").find("input").caret(-1);return false}var w=a(this).closest("li"),v=w.find(".tag-editor-tag");if(f.beforeTagDelete(l,p,s,v.html())===false){return false}v.addClass("deleted").animate({width:0},175,function(){w.remove();m()});r();return false});if(f.clickDelete){p.on("mousedown",".tag-editor-tag",function(x){if(x.ctrlKey||x.which>1){var w=a(this).closest("li"),v=w.find(".tag-editor-tag");if(f.beforeTagDelete(l,p,s,v.html())===false){return false}v.addClass("deleted").animate({width:0},175,function(){w.remove();m()});r();return false}})}p.on("click",".tag-editor-tag",function(B){if(f.clickDelete&&(B.ctrlKey||B.which>1)){return false}if(!a(this).hasClass("active")){var x=a(this).html();var A=Math.abs((a(this).offset().left-B.pageX)/a(this).width()),w=parseInt(x.length*A),y=a(this).html('<input type="text" maxlength="'+f.maxLength+'" value="'+x+'">').addClass("active").find("input");y.data("old_tag",x).tagEditorInput().focus().caret(w);if(f.autocomplete){var z=a.extend({},f.autocomplete);var v="select" in z?f.autocomplete.select:"";z.select=function(D,C){if(v){v(D,C)}setTimeout(function(){p.trigger("click",[a(".active",p).find("input").closest("li").next("li").find(".tag-editor-tag")])},20)};y.autocomplete(z)}}return false});function k(x){var v=x.closest("li"),z=x.val().replace(/ +/," ").split(f.dregex),y=x.data("old_tag");var w=s.slice(0);for(i=0;i<z.length;i++){t=a.trim(z[i]).slice(0,f.maxLength);if(t){if(f.forceLowercase){t=t.toLowerCase()}t=f.beforeTagSave(l,p,w,y,t)||t;if(~a.inArray(t,w)){a(".tag-editor-tag",p).each(function(){if(a(this).html()==t){a(this).closest("li").remove()}})}w.push(t);v.before('<li><div class="tag-editor-spacer">&nbsp;'+f.delimiter[0]+'</div><div class="tag-editor-tag">'+t+'</div><div class="tag-editor-delete"><i></i></div></li>')}}x.attr("maxlength",f.maxLength).removeData("old_tag").val("").focus();r()}p.on("blur","input",function(y){var w=a(this),x=w.data("old_tag"),v=a.trim(w.val().replace(/ +/," ").replace(f.dregex,f.delimiter[0]));if(!v){if(x&&f.beforeTagDelete(l,p,s,x)===false){w.val(x).focus();g=false;r();return}try{w.closest("li").remove()}catch(y){}if(x){r()}}else{if(v.indexOf(f.delimiter[0])>=0){k(w);return}else{if(v!=x){if(f.forceLowercase){v=v.toLowerCase()}v=f.beforeTagSave(l,p,s,x,v)||v;a(".tag-editor-tag:not(.active)",p).each(function(){if(a(this).html()==v){a(this).closest("li").remove()}})}}}w.parent().html(v).removeClass("active");if(v!=x){r()}m()});var o;p.on("paste","input",function(v){a(this).removeAttr("maxlength");o=a(this);setTimeout(function(){k(o)},30)});var q;p.on("keypress","input",function(v){if(f.delimiter.indexOf(String.fromCharCode(v.which))>=0){q=a(this);setTimeout(function(){k(q)},20)}});p.on("keydown","input",function(v){var y=a(this);if(f.keyboardEdit&&((v.which==37||!f.autocomplete&&v.which==38)&&!y.caret()||v.which==8&&!y.val())){var x=y.closest("li").prev("li").find(".tag-editor-tag");if(x.length){x.click().find("input").caret(-1)}else{if(y.val()){a(n).insertBefore(y.closest("li")).find(".tag-editor-tag").click()}}return false}else{if((v.which==39||!f.autocomplete&&v.which==40)&&(y.caret()==y.val().length)){var w=y.closest("li").next("li").find(".tag-editor-tag");if(w.length){w.click().find("input").caret(0)}else{if(y.val()){p.click()}}return false}else{if(v.which==9){if(v.shiftKey){var x=y.closest("li").prev("li").find(".tag-editor-tag");if(x.length){x.click().find("input").caret(0)}else{if(y.val()){a(n).insertBefore(y.closest("li")).find(".tag-editor-tag").click()}else{l.attr("disabled","disabled");setTimeout(function(){l.removeAttr("disabled")},30);return}}return false}else{var w=y.closest("li").next("li").find(".tag-editor-tag");if(w.length){w.click().find("input").caret(0)}else{if(y.val()){p.click()}else{return}}return false}}else{if(f.keyboardEdit&&(v.which==46&&(!a.trim(y.val())||(y.caret()==y.val().length)))){var w=y.closest("li").next("li").find(".tag-editor-tag");if(w.length){w.click().find("input").caret(0)}else{if(y.val()){p.click()}}return false}else{if(v.which==13){p.trigger("click",[y.closest("li").next("li").find(".tag-editor-tag")]);return false}else{if(f.keyboardEdit&&(v.which==36&&!y.caret())){p.find(".tag-editor-tag").first().click()}else{if(f.keyboardEdit&&(v.which==35&&y.caret()==y.val().length)){p.find(".tag-editor-tag").last().click()}else{if(v.which==27){y.val(y.data("old_tag")?y.data("old_tag"):"").blur();return false}}}}}}}}});var u=f.initialTags.length?f.initialTags:l.val().split(f.dregex);for(i=0;i<u.length;i++){var t=a.trim(u[i].replace(/ +/," "));if(t){if(f.forceLowercase){t=t.toLowerCase()}s.push(t);p.append('<li><div class="tag-editor-spacer">&nbsp;'+f.delimiter[0]+'</div><div class="tag-editor-tag">'+t+'</div><div class="tag-editor-delete"><i></i></div></li>')}}r(true);if(f.sortable&&a.fn.sortable){p.sortable({distance:5,cancel:".tag-editor-spacer, input",helper:"clone",update:function(){r()}})}})};a.fn.tagEditor.defaults={initialTags:[],maxLength:50,delimiter:",;",placeholder:"",forceLowercase:true,clickDelete:false,keyboardEdit:true,sortable:true,autocomplete:null,onChange:function(){},beforeTagSave:function(){},beforeTagDelete:function(){}}}(jQuery));
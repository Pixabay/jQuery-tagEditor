/*
	jQuery tagEditor v1.0.18 modified by Marek Jasinski
    Copyright (c) 2014 Simon Steinberger / Pixabay
    GitHub: https://github.com/Pixabay/jQuery-tagEditor
	License: http://www.opensource.org/licenses/mit-license.php
*/
!function(a){a.fn.tagEditorInput=function(){var b=" ",c=a(this),d=parseInt(c.css("fontSize")),e=a("<span/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:c.css("fontSize"),fontFamily:c.css("fontFamily"),fontWeight:c.css("fontWeight"),letterSpacing:c.css("letterSpacing"),whiteSpace:"nowrap"}),f=function(){if(b!==(b=c.val())){e.html(b.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));var a=e.width()+d;20>a&&(a=20),a!=c.width()&&c.width(a)}};return e.insertAfter(c),c.bind("keyup keydown focus",f)},a.fn.tagEditor=function(b,c,d){function e(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function f(a){switch(a.substr(0,1)){case"@":a=a.substring(1);break;case"$":a="#"===a.substr(1,1)?a.substring(2):a.substring(1);break;case"#":("vj:"===a.substr(1,3)||"vJ:"===a.substr(1,3)||"Vj:"===a.substr(1,3)||"VJ:"===a.substr(1,3))&&(a=a.substring(4))}return a}function g(a){switch(a.substr(0,1)){case"@":a="fa-at";break;case"$":a="#"===a.substr(1,1)?"fa-globe":"fa-user";break;case"#":a="vj:"===a.substr(1,3)||"vJ:"===a.substr(1,3)||"Vj:"===a.substr(1,3)||"VJ:"===a.substr(1,3)?"visual vj":"";break;default:a=""}return a}function m(b){if(8==b.which||46==b.which||b.ctrlKey&&88==b.which){try{var c=getSelection(),d=a(c.getRangeAt(0).commonAncestorContainer)}catch(b){d=0}if(d&&d.hasClass("tag-editor")){var e=[],f=c.toString().split(d.prev().data("options").dregex);for(i=0;i<f.length;i++){var g=a.trim(f[i]);g&&e.push(g)}return a(".tag-editor-tag",d).each(function(){~a.inArray(a(this).text(),e)&&a(this).closest("li").find(".tag-editor-delete").click()}),!1}}}var h,j=a.extend({},a.fn.tagEditor.defaults,b),k=this;if(j.dregex=new RegExp("["+j.delimiter.replace("-","-")+"]","g"),"string"==typeof b){var l=[];return k.each(function(){var e=a(this),g=e.data("options"),h=e.next(".tag-editor");if("getTags"==b)l.push({field:e[0],editor:h,tags:h.data("tags")});else if("addTag"==b){if(g.maxTags&&h.data("tags").length>=g.maxTags)return!1;a('<li><div class="tag-editor-spacer">&nbsp;'+g.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>').appendTo(h).find(".tag-editor-tag").html('<input type="text" maxlength="'+g.maxLength+'">').addClass("active").find("input").val(f(c)).attr("data-tag",c).blur(),d?a(".placeholder",h).remove():h.click()}else"removeTag"==b?(a(".tag-editor-tag",h).filter(function(){return a(this).attr("data-tag")==c}).closest("li").find(".tag-editor-delete").click(),d||h.click()):"destroy"==b&&e.removeClass("tag-editor-hidden-src").removeData("options").off("focus.tag-editor").next(".tag-editor").remove()}),"getTags"==b?l:this}return window.getSelection&&a(document).off("keydown.tag-editor").on("keydown.tag-editor",m),k.each(function(){function k(){j.placeholder&&!a(".deleted, .placeholder, input",d).length&&d.append('<li class="placeholder"><div>'+j.placeholder+"</div></li>")}function l(e){var f=c.toString();c=a(".tag-editor-tag:not(.deleted)",d).map(function(b,c){var d=a.trim(a(this).hasClass("active")?a(this).find("input").val():a(c).attr("data-tag"));return d?d:void 0}).get(),d.data("tags",c),b.val(c.join(j.delimiter[0])),e||f!=c.toString()&&j.onChange(b,d,c),k()}function m(h){for(var p,i=h.closest("li"),k=h.val().replace(/ +/," ").split(j.dregex),m=h.data("old_tag"),n=c.slice(0),o=!1,q=0;q<k.length;q++)if(r=a.trim(k[q]).slice(0,j.maxLength),j.forceLowercase&&(r=r.toLowerCase()),p=j.beforeTagSave(b,d,n,m,r),r=p||r,p!==!1&&r&&(j.removeDuplicates&&~a.inArray(r,n)&&a(".tag-editor-tag",d).each(function(){a(this).text()==r&&a(this).closest("li").remove()}),n.push(r),i.before('<li><div class="tag-editor-spacer">&nbsp;'+j.delimiter[0]+'</div><div class="tag-editor-tag" data-tag="'+e(r)+'"><i class="fa '+g(e(r))+'"></i>'+f(e(r))+'</div><div class="tag-editor-delete"><i></i></div></li>'),j.maxTags&&n.length>=j.maxTags)){o=!0;break}h.attr("maxlength",j.maxLength).removeData("old_tag").val(""),o?h.blur():h.focus(),l()}var b=a(this),c=[],d=a("<ul "+(j.clickDelete?'oncontextmenu="return false;" ':"")+'class="tag-editor"></ul>').insertAfter(b);b.addClass("tag-editor-hidden-src").data("options",j).on("focus.tag-editor",function(){d.click()}),d.append('<li style="width:1px">&nbsp;</li>');var i='<li><div class="tag-editor-spacer">&nbsp;'+j.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>';d.click(function(b,c){var e,g,f=99999;if(!window.getSelection||""==getSelection())return j.maxTags&&d.data("tags").length>=j.maxTags?(d.find("input").blur(),!1):(h=!0,a("input:focus",d).blur(),h?(h=!0,a(".placeholder",d).remove(),c&&c.length?g="before":a(".tag-editor-tag",d).each(function(){var d=a(this),h=d.offset(),i=h.left,j=h.top;b.pageY>=j&&b.pageY<=j+d.height()&&(b.pageX<i?(g="before",e=i-b.pageX):(g="after",e=b.pageX-i-d.width()),f>e&&(f=e,c=d))}),"before"==g?a(i).insertBefore(c.closest("li")).find(".tag-editor-tag").click():"after"==g?a(i).insertAfter(c.closest("li")).find(".tag-editor-tag").click():a(i).appendTo(d).find(".tag-editor-tag").click(),!1):!1)}),d.on("click",".tag-editor-delete",function(e){if(a(this).prev().hasClass("active"))return a(this).closest("li").find("input").caret(-1),!1;var f=a(this).closest("li"),g=f.find(".tag-editor-tag");return j.beforeTagDelete(b,d,c,g.text())===!1?!1:(g.addClass("deleted").animate({width:0},j.animateDelete,function(){f.remove(),k(),j.afterTagDelete(b,d,c,g.text())}),l(),!1)}),j.clickDelete&&d.on("mousedown",".tag-editor-tag",function(e){if(e.ctrlKey||e.which>1){var f=a(this).closest("li"),g=f.find(".tag-editor-tag");return j.beforeTagDelete(b,d,c,g.text())===!1?!1:(g.addClass("deleted").animate({width:0},j.animateDelete,function(){f.remove(),k()}),l(),!1)}}),d.on("click",".tag-editor-tag",function(b){if(j.clickDelete&&(b.ctrlKey||b.which>1))return!1;if(!a(this).hasClass("active")){var c=a(this).html(),e=a(this).attr("data-tag");e||(e="");var f=Math.abs((a(this).offset().left-b.pageX)/a(this).width()),g=parseInt(c.length*f),h=a(this).html('<input type="text" maxlength="'+j.maxLength+'" value="'+e+'">').addClass("active").find("input");if(h.data("old_tag",e).tagEditorInput().focus().caret(g),j.autocomplete){var i=a.extend({},j.autocomplete),k="select"in i?j.autocomplete.select:"";i.select=function(b,c){k&&k(b,c),setTimeout(function(){d.trigger("click",[a(".active",d).find("input").closest("li").next("li").find(".tag-editor-tag")])},20)},h.autocomplete(i)}}return!1}),d.on("blur","input",function(i){i.stopPropagation();var n=a(this),o=n.data("old_tag"),p=a.trim(n.val().replace(/ +/," ").replace(j.dregex,j.delimiter[0]));if(p){if(p.indexOf(j.delimiter[0])>=0)return void m(n);if(p!=o)if(j.forceLowercase&&(p=p.toLowerCase()),cb_val=j.beforeTagSave(b,d,c,o,p),p=cb_val||p,cb_val===!1){if(o)return n.val(o).focus(),h=!1,void l();try{n.closest("li").remove()}catch(i){}o&&l()}else j.removeDuplicates&&a(".tag-editor-tag:not(.active)",d).each(function(){a(this).text()==p&&a(this).closest("li").remove()})}else{if(o&&j.beforeTagDelete(b,d,c,o)===!1)return n.val(o).focus(),h=!1,void l();try{n.closest("li").remove()}catch(i){}o&&l()}n.parent().text(f(e(p))).attr("data-tag",e(p)).removeClass("active").prepend('<i class="fa '+g(e(p))+'"></i>'),p!=o&&l(),k()});var n;d.on("paste","input",function(b){a(this).removeAttr("maxlength"),n=a(this),setTimeout(function(){m(n)},30)});var o;d.on("keypress","input",function(b){j.delimiter.indexOf(String.fromCharCode(b.which))>=0&&(o=a(this),setTimeout(function(){m(o)},20))}),d.on("keydown","input",function(c){var e=a(this);if((37==c.which||!j.autocomplete&&38==c.which)&&!e.caret()||8==c.which&&!e.val()){var f=e.closest("li").prev("li").find(".tag-editor-tag");return f.length?f.click().find("input").caret(-1):!e.val()||j.maxTags&&d.data("tags").length>=j.maxTags||a(i).insertBefore(e.closest("li")).find(".tag-editor-tag").click(),!1}if((39==c.which||!j.autocomplete&&40==c.which)&&e.caret()==e.val().length){var g=e.closest("li").next("li").find(".tag-editor-tag");return g.length?g.click().find("input").caret(0):e.val()&&d.click(),!1}if(9==c.which){if(c.shiftKey){var f=e.closest("li").prev("li").find(".tag-editor-tag");if(f.length)f.click().find("input").caret(0);else{if(!e.val()||j.maxTags&&d.data("tags").length>=j.maxTags)return b.attr("disabled","disabled"),void setTimeout(function(){b.removeAttr("disabled")},30);a(i).insertBefore(e.closest("li")).find(".tag-editor-tag").click()}return!1}var g=e.closest("li").next("li").find(".tag-editor-tag");if(g.length)g.click().find("input").caret(0);else{if(!e.val())return;d.click()}return!1}if(!(46!=c.which||a.trim(e.val())&&e.caret()!=e.val().length)){var g=e.closest("li").next("li").find(".tag-editor-tag");return g.length?g.click().find("input").caret(0):e.val()&&d.click(),!1}if(13==c.which)return d.trigger("click",[e.closest("li").next("li").find(".tag-editor-tag")]),j.afterClickEnter(),!1;if(36!=c.which||e.caret()){if(35==c.which&&e.caret()==e.val().length)d.find(".tag-editor-tag").last().click();else if(27==c.which)return e.val(e.data("old_tag")?e.data("old_tag"):"").blur(),!1}else d.find(".tag-editor-tag").first().click()});for(var p=j.initialTags.length?j.initialTags:b.val().split(j.dregex),q=0;q<p.length&&!(j.maxTags&&q>=j.maxTags);q++){var r=a.trim(p[q].replace(/ +/," "));r&&(j.forceLowercase&&(r=r.toLowerCase()),c.push(r),d.append('<li><div class="tag-editor-spacer">&nbsp;'+j.delimiter[0]+'</div><div class="tag-editor-tag" data-tag="'+e(r)+'"><i class="fa '+g(e(r))+'"></i>'+f(e(r))+'</div><div class="tag-editor-delete"><i></i></div></li>'))}l(!0),j.sortable&&a.fn.sortable&&d.sortable({distance:5,cancel:".tag-editor-spacer, input",helper:"clone",update:function(){l()}})})},a.fn.tagEditor.defaults={initialTags:[],maxTags:0,maxLength:50,delimiter:",;",placeholder:"",forceLowercase:!0,removeDuplicates:!0,clickDelete:!1,animateDelete:175,sortable:!0,autocomplete:null,onChange:function(){},beforeTagSave:function(){},beforeTagDelete:function(){},afterTagDelete:function(){},afterClickEnter:function(){}}}(jQuery);